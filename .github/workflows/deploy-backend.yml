name: Deploy Backend to Cloud Run

on:
  push:
    paths:
      - 'backend/**'
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Build and push Docker image
        run: |
          cd backend
          gcloud builds submit --tag gcr.io/${{ secrets.GCP_PROJECT_ID }}/rag-chatboard-api
      
      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy rag-chatboard-api \
            --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/rag-chatboard-api \
            --platform managed \
            --region us-central1 \
            --allow-unauthenticated \
            --set-env-vars "CORS_ORIGINS=https://asmamasood.github.io,http://localhost:3000" \
            --set-secrets "COHERE_API_KEY=cohere-api-key:latest,QDRANT_URL=qdrant-url:latest,QDRANT_API_KEY=qdrant-api-key:latest,GEMINI_API_KEY=gemini-api-key:latest,ADMIN_SECRET=admin-secret:latest"
      
      - name: Get service URL
        run: |
          echo "Backend deployed to:"
          gcloud run services describe rag-chatboard-api --region us-central1 --format 'value(status.url)'
